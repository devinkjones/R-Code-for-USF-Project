## R code to combine downloaded USGS NAWQA Pesticide Synthesis Project data
## <https://water.usgs.gov/nawqa/pnsp/usage/maps/county-level/>

## Before starting, download the datasets from the above website by right-clicking the 'Year(s)' of interest, and 'Save Link As' a .txt file 
## If multiple years are selected, keep all datasets in the same folder 
## If you select datasets between 2013-2016, data is still preliminary, so be sure to save/deposit files you use so the results can be replicated even when those files get updated

## National Pesticide Synthesis Project
## USGS NAWQA dataset

## Load in libraries
library(reshape)
library(dplyr)
library(rJava)
library(tidyr)
library(xlsx)
library(stringr)

## Step One: Set working directory to the file location with the .txt files for the years to combine
## I only have 1992-2012 in the directory, as 2013-2016 are preliminary, and 2017 are preliminary and do not include California
setwd("/Users/devinkjones/Desktop/PesticideSynthesisData/1992-2012/")

## Step Two: Retrieve a list of files inside of our working directory
## We could tell it where to find the file, but have already set the working directory
## I have included the 'pattern' to identify the files (all estimated pesticide files are .txt files)
file_name <- list.files(pattern = "*.txt")

## Step Three: Read in the data from each 'file_name' by applying 'read.table' across the list
## 'sep = "\t"' refers to tab-delimited data, which is what our .txt files are coded with
## Include 'header = TRUE' to keep the headings of each dataset (so we can combine columns)
mydata <- lapply(file_name, read.table, sep = "/t", header = TRUE, row.names = NULL)

## Make sure data is read in
## Should be a list of X datasets (1992-2012 is 21 data sets; 6 variables and 300,000+ observations)
str(mydata)

## Step Four: Merge entered/retrieved data now for all datasets
## 'do.call' runs the 'rbind' function across all items in 'mydata' (i.e., runs 'rbind' on each of the datasets)
mydf <- do.call(rbind, mydata)

## Step Five: Clean variables within the combined dataset
## Extend the length of 'COUNTY_FIPS_CODE' to 3 digits; Have to do this or we'll not be able to mesh site/biota/pesticide datasets
## Extend the length of 'STATE_FIPS_CODE' to 2 digits
mydf$COUNTY_FIPS_CODE <- str_pad(mydf$COUNTY_FIPS_CODE, 3, pad = "0")
mydf$STATE_FIPS_CODE <- str_pad(mydf$STATE_FIPS_CODE, 2, pad = "0")

## Step Six: Create a variable the includes 'YEAR'+'STATE_FIPS_CODE'+'COUNTY_FIPS_CODE'
## With this, we should be able to match variables from 'CollectionSite' dataset and the 'InvertebrateBioData' dataset
cols<- c("YEAR","STATE_FIPS_CODE","COUNTY_FIPS_CODE")
mydf$YEAR_STATE_COUNTY <- do.call(paste, c(mydf[cols], sep = "_"))

## Can now merge with the 'CollectionSite' and 'InvertebrateBioData' datasets
